<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
</head>
<body>
  <h1>Admin Panel (YubiKey Protected)</h1>

  <button onclick="registerYubiKey()">Register YubiKey</button>
  <button onclick="authenticateWithYubiKey()">Login with YubiKey</button>

  <div id="controls" style="display:none;">
    <h2>Manage Links</h2>
    <input type="text" id="newCode" placeholder="Code (optional)">
    <input type="text" id="newUrl" placeholder="https://example.com">
    <button onclick="addLink()">Add</button>

    <ul id="links"></ul>
  </div>

  <script>
    let credentialId = null;

    async function registerYubiKey() {
      try {
        const res = await fetch('https://link-sharing-backend.ikrish61.workers.dev/auth/register');
        const data = await res.json();

        const pubKey = {
          ...data.pubKey,
          challenge: Uint8Array.from(atob(data.challenge.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0)),
          user: {
            ...data.pubKey.user,
            id: Uint8Array.from(data.pubKey.user.id.data)
          }
        };

        const cred = await navigator.credentials.create({ publicKey: pubKey });
        alert("YubiKey registered successfully!");
      } catch (err) {
        console.error("Registration failed", err);
        alert("Registration failed");
      }
    }

    async function authenticateWithYubiKey() {
      try {
        const allowCredentials = [{
          id: Uint8Array.from(atob(localStorage.getItem("yubiKeyId") || ""), c => c.charCodeAt(0)),
          type: "public-key"
        }];

        const cred = await navigator.credentials.get({
          publicKey: {
            challenge: new Uint8Array(32),
            allowCredentials
          }
        });

        credentialId = btoa(String.fromCharCode(...new Uint8Array(cred.rawId)));
        localStorage.setItem("yubiKeyId", credentialId);

        const res = await fetch('https://link-sharing-backend.ikrish61.workers.dev/auth/verify', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: credentialId })
        });

        const out = await res.json();
        if (out.status === "ok") {
          document.getElementById("controls").style.display = "block";
          loadLinks();
        } else {
          throw new Error("Auth rejected");
        }
      } catch (err) {
        console.error("Auth failed", err);
        alert("YubiKey authentication failed.");
      }
    }

    async function loadLinks() {
      const res = await fetch('https://link-sharing-backend.ikrish61.workers.dev/api/list', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ credential: { id: credentialId } })
      });

      const data = await res.json();
      const list = document.getElementById("links");
      list.innerHTML = "";

      data.forEach(link => {
        const li = document.createElement("li");
        li.innerText = `${link.code}: ${link.url}`;
        list.appendChild(li);
      });
    }

    async function addLink() {
      const code = document.getElementById("newCode").value;
      const url = document.getElementById("newUrl").value;

      await fetch('https://link-sharing-backend.ikrish61.workers.dev/api/add', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ credential: { id: credentialId }, code, url })
      });

      loadLinks();
    }
  </script>
</body>
</html>
