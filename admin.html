// === Cloudflare Worker with click tracking and management API (with token auth) ===

const ADMIN_TOKEN = "YOUR_SECRET_TOKEN_HERE"; // Replace this with your actual token

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const headers = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS, HEAD",
      "Access-Control-Allow-Headers": "Content-Type"
    };

    if (request.method === "OPTIONS") {
      return new Response(null, { headers });
    }

    const pathname = url.pathname;
    const isAdminRoute = pathname.startsWith("/api/") && pathname !== "/api/share";
    const token = url.searchParams.get("token");

    if (isAdminRoute && token !== ADMIN_TOKEN) {
      return new Response("Unauthorized", { status: 401, headers });
    }

    // === API: LIST ALL ===
    if (request.method === "GET" && pathname === "/api/list") {
      const list = await env.LINKS.list();
      const result = {};
      for (const key of list.keys) {
        const value = await env.LINKS.get(key.name);
        try {
          result[key.name] = JSON.parse(value);
        } catch (e) {
          result[key.name] = { error: "Invalid JSON" };
        }
      }
      return new Response(JSON.stringify(result), {
        headers: { "Content-Type": "application/json", ...headers }
      });
    }

    // === REDIRECT ===
    if (request.method === "GET" && pathname.length === 7) {
      const code = pathname.slice(1);
      const raw = await env.LINKS.get(code);
      if (!raw) return new Response("Not found", { status: 404, headers });

      const data = JSON.parse(raw);
      data.clicks += 1;
      data.lastAccess = Date.now();
      data.clickLog.push(Date.now());
      await env.LINKS.put(code, JSON.stringify(data));

      return Response.redirect(data.url, 302);
    }

    // === HEAD for code existence ===
    if (request.method === "HEAD" && pathname.length === 7) {
      const code = pathname.slice(1);
      const exists = await env.LINKS.get(code);
      return new Response(null, { status: exists ? 200 : 404, headers });
    }

    // === API: CREATE ===
    if (request.method === "POST" && pathname === "/api/share") {
      const { url: longUrl } = await request.json();
      if (!longUrl || !longUrl.startsWith("http")) {
        return new Response("Invalid URL", { status: 400, headers });
      }

      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code;
      do {
        code = Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join("");
      } while (await env.LINKS.get(code));

      const now = Date.now();
      const data = {
        url: longUrl,
        clicks: 0,
        created: now,
        lastAccess: null,
        clickLog: []
      };

      await env.LINKS.put(code, JSON.stringify(data));
      return new Response(JSON.stringify({ code }), {
        headers: { "Content-Type": "application/json", ...headers }
      });
    }

    // === API: EDIT ===
    if (request.method === "POST" && pathname === "/api/edit") {
      const { code, newUrl } = await request.json();
      const existing = await env.LINKS.get(code);
      if (!existing) return new Response("Not found", { status: 404, headers });
      const data = JSON.parse(existing);
      data.url = newUrl;
      await env.LINKS.put(code, JSON.stringify(data));
      return new Response("Updated", { status: 200, headers });
    }

    // === API: DELETE ===
    if (request.method === "POST" && pathname === "/api/delete") {
      const { code } = await request.json();
      await env.LINKS.delete(code);
      return new Response("Deleted", { status: 200, headers });
    }

    // === API: ADD (manual) ===
    if (request.method === "POST" && pathname === "/api/add") {
      const { code, url: longUrl } = await request.json();
      const exists = await env.LINKS.get(code);
      if (exists) return new Response("Code exists", { status: 409, headers });

      const now = Date.now();
      const data = {
        url: longUrl,
        clicks: 0,
        created: now,
        lastAccess: null,
        clickLog: []
      };
      await env.LINKS.put(code, JSON.stringify(data));
      return new Response("Added", { status: 201, headers });
    }

    return new Response("Not found", { status: 404, headers });
  }
};
